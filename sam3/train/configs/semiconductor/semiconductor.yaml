# @package _global_
defaults:
  - _self_

# 1. ê²½ë¡œ ì„¤ì • (ìˆ˜ì • í•„ìš”)
paths:
  dataset_root: C:/data/black_weight_mask/crack  # ë°ì´í„°ì…‹ ì‹¤ì œ ê²½ë¡œë¡œ ë³€ê²½
  experiment_log_dir: logs/semiconductor_finetune
  bpe_path: C:/workspace/sam3/assets/bpe_simple_vocab_16e6.txt.gz

# 2. í•™ìŠµ ë°ì´í„° ì„¤ì •
train_config:
  num_images: null # nullì´ë©´ ì „ì²´ ë°ì´í„° ì‚¬ìš©
  
  # Loss ì„¤ì • (Segmentation ì‚¬ìš© ì‹œ Mask Loss ì¶”ê°€ í•„ìš”)
  loss:
    _target_: sam3.train.loss.sam3_loss.Sam3LossWrapper
    matcher: ${scratch.matcher}
    o2m_weight: 2.0
    o2m_matcher:
      _target_: sam3.train.matcher.BinaryOneToManyMatcher
      alpha: 0.3
      threshold: 0.4
      topk: 4
    use_o2m_matcher_on_o2m_aux: false
    loss_fns_find:
      - _target_: sam3.train.loss.loss_fns.Boxes
        weight_dict:
          loss_bbox: 5.0
          loss_giou: 2.0
      - _target_: sam3.train.loss.loss_fns.IABCEMdetr
        weak_loss: False
        weight_dict:
          loss_ce: 20.0
          presence_loss: 20.0
        pos_weight: 10.0
        alpha: 0.25
        gamma: 2
        use_presence: True
        pos_focal: false
        pad_n_queries: 200
        pad_scale_pos: 1.0
      # Segmentationì„ í•œë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
      - _target_: sam3.train.loss.loss_fns.Masks
        focal_alpha: 0.25
        focal_gamma: 2.0
        weight_dict:
          loss_mask: 200.0
          loss_dice: 10.0
        compute_aux: false

    loss_fn_semantic_seg: null
    scale_by_find_batch_size: ${scratch.scale_by_find_batch_size}

  # Transform ì„¤ì • (ê¸°ë³¸ê°’ ìœ ì§€)
  train_transforms:
    - _target_: sam3.train.transforms.basic_for_api.ComposeAPI
      transforms:
        - _target_: sam3.train.transforms.filter_query_transforms.FlexibleFilterFindGetQueries
          query_filter:
            _target_: sam3.train.transforms.filter_query_transforms.FilterCrowds
        - _target_: sam3.train.transforms.point_sampling.RandomizeInputBbox
          box_noise_std: 0.1
          box_noise_max: 20
        - _target_: sam3.train.transforms.segmentation.DecodeRle
        - _target_: sam3.train.transforms.basic_for_api.RandomResizeAPI
          sizes:
            _target_: sam3.train.transforms.basic.get_random_resize_scales
            size: ${scratch.resolution}
            min_size: 480
            rounded: false
          max_size:
            _target_: sam3.train.transforms.basic.get_random_resize_max_size
            size: ${scratch.resolution}
          square: true
          consistent_transform: ${scratch.consistent_transform}
        - _target_: sam3.train.transforms.basic_for_api.PadToSizeAPI
          size: ${scratch.resolution}
          consistent_transform: ${scratch.consistent_transform}
        - _target_: sam3.train.transforms.basic_for_api.ToTensorAPI
        - _target_: sam3.train.transforms.filter_query_transforms.FlexibleFilterFindGetQueries
          query_filter:
            _target_: sam3.train.transforms.filter_query_transforms.FilterEmptyTargets
        - _target_: sam3.train.transforms.basic_for_api.NormalizeAPI
          mean: ${scratch.train_norm_mean}
          std: ${scratch.train_norm_std}
        - _target_: sam3.train.transforms.filter_query_transforms.FlexibleFilterFindGetQueries
          query_filter:
            _target_: sam3.train.transforms.filter_query_transforms.FilterEmptyTargets
    - _target_: sam3.train.transforms.filter_query_transforms.FlexibleFilterFindGetQueries
      query_filter:
        _target_: sam3.train.transforms.filter_query_transforms.FilterFindQueriesWithTooManyOut
        max_num_objects: ${scratch.max_ann_per_img}

  val_transforms:
    - _target_: sam3.train.transforms.basic_for_api.ComposeAPI
      transforms:
        - _target_: sam3.train.transforms.basic_for_api.RandomResizeAPI
          sizes: ${scratch.resolution}
          max_size:
            _target_: sam3.train.transforms.basic.get_random_resize_max_size
            size: ${scratch.resolution}
          square: true
          consistent_transform: False
        - _target_: sam3.train.transforms.basic_for_api.ToTensorAPI
        - _target_: sam3.train.transforms.basic_for_api.NormalizeAPI
          mean: ${scratch.train_norm_mean}
          std: ${scratch.train_norm_std}

# 3. ëª¨ë¸ ë° í•™ìŠµ íŒŒë¼ë¯¸í„°
scratch:
  enable_segmentation: True # Segmentation ë§ˆìŠ¤í¬ê°€ ìˆë‹¤ë©´ Trueë¡œ ë³€ê²½
  d_model: 256
  pos_embed:
    _target_: sam3.model.position_encoding.PositionEmbeddingSine
    num_pos_feats: ${scratch.d_model}
    normalize: true
    scale: null
    temperature: 10000
  
  use_presence_eval: True
  original_box_postprocessor:
    _target_: sam3.eval.postprocessors.PostProcessImage
    max_dets_per_img: -1
    use_original_ids: true
    use_original_sizes_box: true
    use_presence: ${scratch.use_presence_eval}

  matcher:
    _target_: sam3.train.matcher.BinaryHungarianMatcherV2
    focal: true
    cost_class: 2.0
    cost_bbox: 5.0
    cost_giou: 2.0
    alpha: 0.25
    gamma: 2
    stable: False
  scale_by_find_batch_size: True

  resolution: 640 # ë°˜ë„ì²´ ì´ë¯¸ì§€ëŠ” ê³ í•´ìƒë„ê°€ ë§ìœ¼ë¯€ë¡œ í•´ìƒë„ í™•ì¸ í•„ìš”
  consistent_transform: False
  max_ann_per_img: 200

  train_norm_mean: [0.485, 0.456, 0.406] # ImageNet Mean (ì¼ë°˜ì )
  train_norm_std: [0.229, 0.224, 0.225]  # ImageNet Std
  val_norm_mean: [0.485, 0.456, 0.406]
  val_norm_std: [0.229, 0.224, 0.225]

  num_train_workers: 4
  num_val_workers: 2
  max_data_epochs: 50 # ë°ì´í„° ì–‘ì— ë”°ë¼ ì¡°ì ˆ
  target_epoch_size: 1000
  hybrid_repeats: 1
  context_length: 2
  gather_pred_via_filesys: false

  lr_scale: 0.1
  lr_transformer: ${times:8e-4,${scratch.lr_scale}}
  lr_vision_backbone: ${times:2.5e-4,${scratch.lr_scale}}
  lr_language_backbone: ${times:5e-5,${scratch.lr_scale}}
  lrd_vision_backbone: 0.9
  wd: 0.1
  scheduler_timescale: 20
  scheduler_warmup: 5
  scheduler_cooldown: 5

  val_batch_size: 1
  collate_fn_val:
    _target_: sam3.train.data.collator.collate_fn_api
    _partial_: true
    repeats: ${scratch.hybrid_repeats}
    dict_key: val_data
    with_seg_masks: ${scratch.enable_segmentation}

  gradient_accumulation_steps: 1
  train_batch_size: 2 # GPU ë©”ëª¨ë¦¬ì— ë§ì¶° ì¡°ì ˆ
  collate_fn:
    _target_: sam3.train.data.collator.collate_fn_api
    _partial_: true
    repeats: ${scratch.hybrid_repeats}
    dict_key: all
    with_seg_masks: ${scratch.enable_segmentation}

# 4. Trainer ì„¤ì •
trainer:
  _target_: sam3.train.trainer.Trainer
  skip_saving_ckpts: false # ì²´í¬í¬ì¸íŠ¸ ì €ì¥ í™œì„±í™”
  empty_gpu_mem_cache_after_eval: True
  skip_first_val: True
  max_epochs: ${scratch.max_data_epochs}
  accelerator: cuda
  seed_value: 42
  val_epoch_freq: 5
  mode: train
  gradient_accumulation_steps: ${scratch.gradient_accumulation_steps}

  distributed:
      # 1. GPU 1ê°œë§Œ ì‚¬ìš©í•  ê²½ìš° ë¶„ì‚° í•™ìŠµ ìì²´ê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ë¹„í™œì„±í™”í•˜ê±°ë‚˜,
      # 2. Windows í˜¸í™˜ì„±ì„ ìœ„í•´ glooë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
      
      # ì¶”ì²œ: GPU 1ê°œë¼ë©´ ë¶„ì‚° í•™ìŠµ ê¸°ëŠ¥ì„ ë„ëŠ” ê²ƒì´ ê°€ì¥ ê¹”ë”í•©ë‹ˆë‹¤.
      # í•˜ì§€ë§Œ ì½”ë“œê°€ ë¶„ì‚° ëª¨ë“œë¥¼ ê°•ì œí•œë‹¤ë©´ 'gloo'ë¡œ ë°”ê¾¸ì„¸ìš”.
      
      backend: gloo  # ğŸ‘ˆ ì—¬ê¸°ë¥¼ 'nccl'ì—ì„œ 'gloo'ë¡œ ë³€ê²½
      find_unused_parameters: True
      gradient_as_bucket_view: True
  loss:
    all: ${train_config.loss}
    default:
      _target_: sam3.train.loss.sam3_loss.DummyLoss

  data:
    train:
      _target_: sam3.train.data.torch_dataset.TorchDataset
      dataset:
        _target_: sam3.train.data.sam3_image_dataset.Sam3ImageDataset
        limit_ids: ${train_config.num_images}
        transforms: ${train_config.train_transforms}
        load_segmentation: ${scratch.enable_segmentation}
        max_ann_per_img: 500000
        multiplier: 1
        max_train_queries: 50000
        max_val_queries: 50000
        training: true
        use_caching: False
        img_folder: ${paths.dataset_root}/train/images
        ann_file: ${paths.dataset_root}/train/annotations.json
      shuffle: True
      batch_size: ${scratch.train_batch_size}
      num_workers: ${scratch.num_train_workers}
      pin_memory: True
      drop_last: True
      collate_fn: ${scratch.collate_fn}

    val:
      _target_: sam3.train.data.torch_dataset.TorchDataset
      dataset:
        _target_: sam3.train.data.sam3_image_dataset.Sam3ImageDataset
        load_segmentation: ${scratch.enable_segmentation}
        coco_json_loader:
          _target_: sam3.train.data.coco_json_loaders.COCO_FROM_JSON
          include_negatives: true
          category_chunk_size: 2
          _partial_: true
        img_folder: ${paths.dataset_root}/val/images
        ann_file: ${paths.dataset_root}/val/annotations.json
        transforms: ${train_config.val_transforms}
        max_ann_per_img: 100000
        multiplier: 1
        training: false
      shuffle: False
      batch_size: ${scratch.val_batch_size}
      num_workers: ${scratch.num_val_workers}
      pin_memory: True
      drop_last: False
      collate_fn: ${scratch.collate_fn_val}

  model:
    _target_: sam3.model_builder.build_sam3_image_model
    bpe_path: ${paths.bpe_path}
    device: cpus
    eval_mode: false
    enable_segmentation: ${scratch.enable_segmentation}
    # [ì¶”ê°€] Pretrained Weight ê²½ë¡œ ì„¤ì •
    # checkpoint_path: /path/to/your/pretrained/sam3.pt 
    # ë§Œì•½ HuggingFaceì—ì„œ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ê²Œ í•˜ë ¤ë©´ ìœ„ ì¤„ì„ ìƒëµí•˜ê±°ë‚˜ nullë¡œ ë‘ì„¸ìš”.
    # load_from_HF: True (ê¸°ë³¸ê°’)

  meters:
    val:
      val_data:
        detection:
          _target_: sam3.eval.coco_writer.PredictionDumper
          iou_type: "bbox"
          dump_dir: ${launcher.experiment_log_dir}/dumps/val
          merge_predictions: True
          postprocessor: ${scratch.original_box_postprocessor}
          gather_pred_via_filesys: ${scratch.gather_pred_via_filesys}
          maxdets: 100
          pred_file_evaluators:
            - _target_: sam3.eval.coco_eval_offline.CocoEvaluatorOfflineWithPredFileEvaluators
              gt_path: ${paths.dataset_root}/val/annotations.json
              tide: False
              iou_type: "bbox"

  optim:
    amp:
      enabled: True
      # Linux only
      # amp_dtype: bfloat16  
      amp_dtype: float16
    optimizer:
      _target_: torch.optim.AdamW
    gradient_clip:
      _target_: sam3.train.optim.optimizer.GradientClipper
      max_norm: 0.1
      norm_type: 2
    param_group_modifiers:
      - _target_: sam3.train.optim.optimizer.layer_decay_param_modifier
        _partial_: True
        layer_decay_value: ${scratch.lrd_vision_backbone}
        apply_to: 'backbone.vision_backbone.trunk'
        overrides:
          - pattern: '*pos_embed*'
            value: 1.0
    options:
      lr:
        - scheduler:
            _target_: sam3.train.optim.schedulers.InverseSquareRootParamScheduler
            base_lr: ${scratch.lr_transformer}
            timescale: ${scratch.scheduler_timescale}
            warmup_steps: ${scratch.scheduler_warmup}
            cooldown_steps: ${scratch.scheduler_cooldown}
        - scheduler:
            _target_: sam3.train.optim.schedulers.InverseSquareRootParamScheduler
            base_lr: ${scratch.lr_vision_backbone}
            timescale: ${scratch.scheduler_timescale}
            warmup_steps: ${scratch.scheduler_warmup}
            cooldown_steps: ${scratch.scheduler_cooldown}
          param_names:
            - 'backbone.vision_backbone.*'
        - scheduler:
            _target_: sam3.train.optim.schedulers.InverseSquareRootParamScheduler
            base_lr: ${scratch.lr_language_backbone}
            timescale: ${scratch.scheduler_timescale}
            warmup_steps: ${scratch.scheduler_warmup}
            cooldown_steps: ${scratch.scheduler_cooldown}
          param_names:
            - 'backbone.language_backbone.*'
      weight_decay:
        - scheduler:
            _target_: fvcore.common.param_scheduler.ConstantParamScheduler
            value: ${scratch.wd}
        - scheduler:
            _target_: fvcore.common.param_scheduler.ConstantParamScheduler
            value: 0.0
          param_names:
            - '*bias*'
          module_cls_names: ['torch.nn.LayerNorm']

  checkpoint:
    save_dir: ${launcher.experiment_log_dir}/checkpoints
    save_freq: 1

  logging:
    tensorboard_writer:
      _target_: sam3.train.utils.logger.make_tensorboard_logger
      log_dir: ${launcher.experiment_log_dir}/tensorboard
      flush_secs: 120
      should_log: True
    wandb_writer: null
    log_dir: ${launcher.experiment_log_dir}/logs
    log_freq: 10

launcher:
  num_nodes: 1
  gpus_per_node: 1 # ì‚¬ìš© ê°€ëŠ¥í•œ GPU ìˆ˜ì— ë§ê²Œ ë³€ê²½
  experiment_log_dir: ${paths.experiment_log_dir}
  multiprocessing_context: forkserver

submitit:
  account: null
  partition: null
  qos: null
  timeout_hour: 72
  use_cluster: False # ë¡œì»¬ ì‹¤í–‰ ì‹œ False
  cpus_per_task: 4
  port_range: [10000, 65000]
  constraint: null